{% extends "base.html" %}
{% load humanize %}

{% block css %}
<style>
.container { max-width: 1200px; }
.card { border-radius: 10px; border: none; }
.card-body img { border-radius: 8px; background: #f8f9fa; }
.card-body h6 { font-weight: 600; }
.card-body strong { font-size: 1rem; }
.input-group button { background-color: #6f42c1; color: white; border: none; }
.input-group button:hover { background-color: #5a339f; }
.btn-outline-danger { border: none; background: #ff4d6d; color: white; }
.btn-outline-danger:hover { background: #e63e5d; }
.card .card-body { padding: 20px; }
.card .card-body span { color: #6c757d; }
.card .card-body strong.fs-5 { color: #000; font-weight: 700; }
.btn-primary { background-color: #6f42c1; border: none; font-weight: 500; }
.btn-primary:hover { background-color: #5a339f; }
.shipping-card { background: #fff; border-radius: 10px; padding: 20px; box-shadow: 0px 2px 6px rgba(0,0,0,0.1); }
.shipping-card h6 { font-weight: 600; margin-bottom: 15px; }
.shipping-card p { margin-bottom: 5px; }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="#">Shop</a></li>
            <li class="breadcrumb-item active" aria-current="page">Cart</li>
        </ol>
    </nav>
   

 



    <form action="{% url 'create_order' %}" method = "POST">
        {% csrf_token %}

                <div class="row">
                    <!-- Left Column - Cart Items -->
                    <div class="col-lg-8">
                        <div id="cart-items-container">
                        <h4 class="mb-4">Cart Items</h4>
                    {% for item in items %}
            <div class="card mb-3 shadow-sm border-0 cart-item-row" data-item-id="{{ item.id }}">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <img src="{{ item.product.image.url }}" style="width: 80px; height: 80px; object-fit: cover;" class="me-3">
                        <div>
                            <h6 class="mb-1">{{ item.product.name }}</h6>
                            {% comment %} Actual price  {% endcomment %}
                            <strong>${{ item.product.prize}}</strong> <br>
                            <small class="text-muted">Vendor: {{ item.product.vendor }}</small>
                        </div>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="input-group" style="width: 120px;">
                            <input type="text" class="form-control text-center quantity-input" data-item-id="{{ item.id }}" value="{{ item.quantity }}" readonly>
                        </div>
                        <input type="hidden" class="max-stock" data-item-id="{{ item.id }}" value="{{ item.product.quantity }}">
                       <strong>${{ item.product.prize|floatformat:2 }}</strong>

                        <button class="btn btn-outline-danger btn-sm delete_cart_item" data-item_id="{{ item.id }}" data-product_id="{{ item.product.id }}">ðŸ—‘</button>
                    </div>
                </div>
            </div>
            {% empty %}
            <p>Your cart is empty.</p>
{% endfor %}

            {% comment %} {% endfor %} {% endcomment %}
            </div>

            <!-- Shipping Details -->
            <div class="shipping-card mt-4">
                <h6>Shipping Details</h6>
                {% for address in addresses %}
                    <p><strong>Full Name:</strong> {{ address.full_name }}</p>
                    <p><strong>Email:</strong> {{ address.email }}</p>
                    <p><strong>Address:</strong> {{ address.address_line1 }}{% if address.address_line2 %}, {{ address.address_line2 }}{% endif %}</p>
                    <p><strong>Phone:</strong> {{ address.phone }}</p>
                    <p><strong>City:</strong> {{ address.city }}</p>
                    <p><strong>State:</strong> {{ address.state }}</p>
                    <p><strong>Zip Code:</strong> {{ address.zip_code }}</p>
                    <p><strong>Country:</strong> {{ address.country }}</p>
                    <div class="form-check mt-2">
                        <input id="address{{address.id}}" value="{{address.id}}" class="form-check-input" type="radio" name="address">
                        <label for="address{{address.id}}">Select Address</label>
                    </div>
                {% empty %}
                    <p>No shipping address available.</p>
                {% endfor %}
            </div>
        </div>
        
        <!-- Right Column - Order Summary -->
      <div class="col-lg-4">
    <h4 class="mb-4">Order Summary</h4>
    <div class="card shadow-sm border-0">
        <div class="card-body">

            <!-- har product -->
            {% for item in items %}
            <div class="d-flex justify-content-between mb-2">
                <span>{{ item.product.name }} Ã— {{ item.quantity }}</span>
                <strong>${{ item.sub_total|floatformat:2 }}</strong>
            </div>
            {% endfor %}

            <hr>

            <!-- subtotal -->
            <div class="d-flex justify-content-between mb-2">
                <span>Sub-total</span>
                <strong>${{ cart_sub_total|floatformat:2 }}</strong>
            </div>

            <!-- shipping -->
            <div class="d-flex justify-content-between mb-2">
                <span>Shipping</span>
                <strong>${{ cart_shipping_total|floatformat:2 }}</strong>
            </div>

            <hr>

            <!-- grand total -->
            <div class="d-flex justify-content-between mb-3">
                <span>Total</span>
                <strong class="fs-5">${{ cart_total|floatformat:2 }}</strong>
            </div>

            <button type="submit" class="btn btn-primary w-100">
                Proceed To Checkout â†’
            </button>
        </div>
    </div>
</div>

    </div>
</div>

    </div>
</div>

</form>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const cartId = "{{ request.session.cart_id|default:'' }}";

    // DELETE ITEM
    document.querySelectorAll(".delete_cart_item").forEach(btn => {
        btn.addEventListener("click", function () {
            const itemId = this.dataset.item_id;
            const productId = this.dataset.product_id;
            const cardRow = this.closest(".cart-item-row");

            fetch(`/delete-cart-item/?id=${productId}&cart_id=${cartId}&item_id=${itemId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.status === "success") {
                        cardRow.remove();
                        document.querySelector("#cart-sub-total").textContent = `$${data.cart_sub_total}`;
                        document.querySelector("#cart-total").textContent = `$${data.cart_sub_total}`;
                        if (data.total_cart_items === 0) {
                            document.querySelector("#cart-items-container").innerHTML =
                                '<p class="text-muted">Your cart is empty.</p>';
                        }
                    }
                });
        });
    });

   
});
</script>

{% endblock %}
